# Менеджер дефектов (микросервисы)

Это приложение для управления дефектами, построенное на основе микросервисной архитектуры с использованием Node.js, Express и PostgreSQL. Все приложение контейнеризовано с помощью Docker.

## Технологии

*   **Бэкенд:** Node.js, Express.js
*   **База данных:** PostgreSQL
*   **Контейнеризация:** Docker, Docker Compose
*   **API-шлюз:** Собственная разработка на `http-proxy-middleware`
*   **Аутентификация:** JWT (JSON Web Tokens)
*   **Валидация:** Zod
*   **Логирование:** Pino (с `pino-http`)

## Архитектура

Приложение следует микросервисной архитектуре:

*   **`api_gateway`:** Единая точка входа для всех клиентских запросов. Он обрабатывает маршрутизацию, аутентификацию, ограничение скорости запросов и CORS. Перенаправляет запросы в соответствующий нижестоящий сервис.
*   **`service_users`:** Управляет всеми операциями, связанными с пользователями, включая регистрацию, вход, управление профилем и получение списка пользователей на уровне администратора.
*   **`service_orders`:** Управляет всеми операциями, связанными с заказами, такими как создание, получение, обновление статуса и отмена.
*   **`postgres`:** Центральная база данных для обоих сервисов.
*   **`initdb/init.sql`**: Единственный источник правды для схемы базы данных.

## Начало работы

Для начала работы с этим проектом вам необходимо установить Docker и Docker Compose на вашем компьютере.

## Сборка и запуск

1.  **Переменные окружения:**

    Этот проект использует файлы `.env` для разных окружений. Вам нужно будет создать файлы `.env.development` и `.env.production`. Вы можете начать, скопировав файл `.env.example`:

    ```bash
    cp .env.example .env.development
    cp .env.example .env.production
    ```

    (Заполните файлы `.env` вашими настройками).

2.  **Запуск приложения:**

    Для запуска приложения в среде разработки используйте:

    ```bash
    NODE_ENV=development docker-compose up --build -d
    ```

    Для запуска приложения в производственной среде используйте:

    ```bash
    NODE_ENV=production docker-compose up --build -d
    ```

3.  **Остановка приложения:**

    ```bash
    docker-compose down
    ```

## API Эндпоинты

API версионируется и доступно по пути `/api/v1`.

### Аутентификация (через `service_users`)

*   `POST /auth/register`: Регистрация нового пользователя.
*   `POST /auth/login`: Вход пользователя и получение JWT.

### Пользователи (через `service_users`)

*   `GET /users/profile`: Получение профиля текущего пользователя.
*   `PUT /users/profile`: Обновление профиля текущего пользователя.

### Админ (через `service_users`)

*   `GET /admin/users`: Получение списка всех пользователей (только для администраторов).
*   `GET /admin/users/:id`: Получение пользователя по ID (только для администраторов).
*   `PUT /admin/users/:id`: Обновление пользователя по ID (только для администраторов).

### Заказы (через `service_orders`)

*   `POST /orders`: Создание нового заказа.
*   `GET /orders`: Получение списка заказов текущего пользователя.
*   `GET /orders/:id`: Получение заказа по его ID.
*   `PATCH /orders/:id/status`: Обновление статуса (только для администраторов).
*   `PATCH /orders/:id/cancel`: Отмена заказа (только владелец).